<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{LambertW Overview}
-->
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache = TRUE)
options(digits = 3)

```


```{r load-packages}
library(LambertW)
library(ggplot2)
library(reshape2)
library(data.table)
```


# Gigantic kurtosis
[Post here](http://stats.stackexchange.com/questions/34565/gigantic-kurtosis)

Have a look at [heavy-tail Lambert W x F](http://www.hindawi.com/journals/tswj/aa/909231/) or [skewed Lambert W x F ](http://projecteuclid.org/euclid.aoas/1318514301) distributions a try (disclaimer: I am the author). In R they are implemented in the [**LambertW**](http://cran.r-project.org/web/packages/LambertW/) package.

Related posts:

  * http://stats.stackexchange.com/questions/33115/whats-the-distribution-of-these-data/47917#47917
  * http://stats.stackexchange.com/questions/20445/how-to-transform-data-to-normality/189991#189991
  
One advantage over Cauchy or student-t distribution with fixed degrees of freedom is that the tail parameters can be estimated from the data -- so you can let the data decide what moments exist.  Moreover the Lambert W x F framework allows you to transform your data and remove skewness / heavy-tails.   Itt is important to note though that OLS does not require Normality of $y$ or $X$.  However, for your EDA it might be worthwhile.

Here is an example of Lambert W x Gaussian estimates applied to equity fund returns.

```{r equity-funds}
library(fEcofin)
ret <- ts(equityFunds[, -1] * 100)
plot(ret)
```


The summary metrics of the returns are similar (not as extreme) as in OP's post.
```{r pairs-metrics}
data_metrics <- function(x) {
  c(mean = mean(x), sd = sd(x), min = min(x), max = max(x), 
    skewness = skewness(x), kurtosis = kurtosis(x))
}
ret.metrics <- t(apply(ret, 2, data_metrics))
ret.metrics
```

Most series show clearly non-Normal characteristics (strong skewness and/or large kurtosis).  Let's Gaussianize each series using a heavy tailed 
Lambert W x Gaussian distribution (= Tukey's h) using a methods of moments
estimator (`IGMM`).
```{r gaussianize-returns}
library(LambertW)
ret.gauss <- Gaussianize(ret, type = "h", method = "IGMM")
colnames(ret.gauss) <- gsub(".X", "", colnames(ret.gauss))

plot(ts(ret.gauss))
```

The time series plots show much fewer tails and also more stable variation over time (not constant though).  Computing the metrics again on the Gaussianized time series yields:

```{r metrics-gaussianized}
ret.gauss.metrics <- t(apply(ret.gauss, 2, data_metrics))
ret.gauss.metrics
```

The `IGMM` algorithm achieved exactly what it was set forth to do: transform the data to have kurtosis equal to $3$. Interestingly, all time series now have negative skewness, which is in line with most financial time series literature.  Important to point out here that `Gaussianize()` operates only marginally, not jointly (analogously to `scale()`).


## Simple bivariate regression

To consider the effect of Gaussianization on OLS consider predicting "EASTEU" return from "INDIA" returns and vice versa.  Even though we are looking at same day returns between $r_{EASTEU, t}$ on $r_{INDIA,t}$ (no lagged variables), it still provides value for a stock market prediction given the 6h+ time difference between India and Europe.

```{r INDIA-easteu, fig.width = 16, fig.height = 8}
layout(matrix(1:2, ncol = 2, byrow = TRUE))
plot(ret[, "INDIA"], ret[, "EASTEU"])
grid()
plot(ret.gauss[, "INDIA"], ret.gauss[, "EASTEU"])
grid()

```
The left scatterplot of the original series shows that the strong outliers did not occur at the same days, but at different times in India and Europe; other than that it is not clear if the data cloud in the center supports no correlation or negative/positive dependency.  Since outliers strongly affect variance and correlation estimates, it is worthwhile to look at the dependency with heavy tails removed (right scatterplot).  Here the patterns are much more clear and the positive relation between India and Eastern Europe market becomes apparent.


```{r fit-models, include = TRUE, eval = FALSE}
# try these models on your own
mod <- lm(EASTEU ~ INDIA * CHINA, data = ret)
mod.robust <- rlm(EASTEU ~ INDIA, data = ret)
mod.gauss <- lm(EASTEU ~ INDIA, data = ret.gauss)

summary(mod)
summary(mod.robust)
summary(mod.gauss)
```

## Granger causality

A Granger causality test based on a  $VAR(5)$ model (I use $p = 5$ to capture the week effect of daily trades) for "EASTEU" and "INDIA" rejects "no Granger causality" for either direction.
```{r vars-ret}
library(vars)
mod.vars <- vars::VAR(ret[, c("EASTEU", "INDIA")], p = 5)
causality(mod.vars, "INDIA")$Granger
causality(mod.vars, "EASTEU")$Granger

```

However, for the Gaussianized data the answer is different!  Here the test can *not* reject H0 that "INDIA does *not* Granger-cause EASTEU", but still rejects that "EASTEU does not Granger-cause INDIA".  So the Gaussianized data supports the hypothesis that European markets drive markets in India the following day.


```{r vars-ret-gauss}
mod.vars.gauss <- vars::VAR(ret.gauss[, c("EASTEU", "INDIA")], p = 5)
causality(mod.vars.gauss, "INDIA")$Granger
causality(mod.vars.gauss, "EASTEU")$Granger
```


Note that it is not clear to me which one is the *right* answer (if any), but it's an interesting observation to make.  Needless to say that this entire Causality testing is contingent on the $VAR(5)$ being the correct model -- which it is most likely not; but I think it serves well for illustratiton.


# fitdistr among Cauchy / Student-T / Normal distributions in R
[Post here](http://stats.stackexchange.com/questions/146026/fitdistr-among-cauchy-student-t-normal-distributions-in-r#comment363074_146026)

```{r wd}
data.path <- "~/Dropbox/LambertW_roxygen/vignettes_tmp/data/"
```

```{r read-data}
fname <- "F-F_Research_Data_Factors_daily.CSV"
library(data.table)
ret <- fread(file.path(data.path, fname), sep = ",", header = TRUE,
             skip = 4)
ret[, date := as.Date(as.character(V1), "%Y%m%d")]
ret[, V1 := NULL]
ret
```

```{r lambertw}
library(LambertW)

mod.mle <- MLE_LambertW(ret[, SMB], type = "h", distname = "normal")
plot(mod.mle)
```
